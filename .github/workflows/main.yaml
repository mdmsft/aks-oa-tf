on:
  workflow_dispatch:
    
name: Main

permissions:
  id-token: write

env:
  TF_INPUT: false
  TF_IN_AUTOMATION: true

jobs:
  plan:
    runs-on: ubuntu-latest
    environment: Plan
    name: Plan
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v1
      - name: Login with service principal
        uses: azure/login@v1
        with:
          client-id: 71d61b9c-20f4-4082-8095-55a701919a61
          tenant-id: 72f988bf-86f1-41af-91ab-2d7cd011db47
          subscription-id: 6f3a143b-51cc-4a89-aa5a-3c98bb3f5e46
      - name: Terraform init
        run: terraform init
      - name: Terraform plan
        run: terraform plan -no-color -out=main.tfplan
      - name: Upload artifact
        uses: actions/upload-artifact@v2
        with:
          name: plan
          path: main.tfplan
          if-no-files-found: error
  apply:
    runs-on: ubuntu-latest
    environment: Apply
    name: Apply
    needs: [plan]
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v1
      - name: Login with service principal
        uses: azure/login@v1
        with:
          client-id: 71d61b9c-20f4-4082-8095-55a701919a61
          tenant-id: 72f988bf-86f1-41af-91ab-2d7cd011db47
          subscription-id: 6f3a143b-51cc-4a89-aa5a-3c98bb3f5e46
      - name: Terraform init
        run: terraform init
      - name: Download artifact
        uses: actions/download-artifact@v2
        with:
          name: plan
      - name: Terraform apply
        run: terraform apply main.tfplan
